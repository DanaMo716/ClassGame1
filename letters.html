<!doctype html>

<html lang="ar" dir="rtl">

<head>

    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>ูุนุจุฉ ูููู ุงููููุฉ - ุชุนููู ุงูุนุฑุจูุฉ</title>

    <style>
         :root {
            --bg: #f7f7fb;
            --card: #ffffff;
            --ink: #222;
            --muted: #666;
            --accent: #3a86ff;
            --ok: #22c55e;
            --bad: #ef4444;
            --shadow: 0 8px 20px rgba(0, 0, 0, .08);
        }
        
        html,
        body {
            height: 100%;
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Amiri", "Cairo", Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .app {
            width: min(1100px, 100%);
        }
        
        header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .title {
            font-weight: 800;
            font-size: clamp(22px, 2.8vw, 32px);
        }
        
        .sub {
            color: var(--muted);
            font-size: 15px;
        }
        
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        
        .stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chip {
            background: #eef2ff;
            color: #1f3aed;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn {
            border: 0;
            padding: 12px 16px;
            border-radius: 10px;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(58, 134, 255, .3);
            transition: transform .05s ease;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.secondary {
            background: #e5e7eb;
            color: #111;
            box-shadow: none;
        }
        
        .btn.good {
            background: var(--ok);
            box-shadow: 0 4px 12px rgba(34, 197, 94, .25);
        }
        
        .btn.bad {
            background: var(--bad);
        }
        
        .board {
            display: grid;
            gap: 14px;
            margin-top: 10px;
            grid-template-columns: 1fr;
        }
        
        .hint {
            background: #f8fafc;
            border: 1px dashed #dbeafe;
            padding: 14px 16px;
            border-radius: 12px;
            color: #0f172a;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hint .left {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .lvl {
            font-weight: 700;
        }
        
        .slots,
        .bank {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            min-height: 80px;
            padding: 18px;
            border-radius: 14px;
            background: #fafafa;
            border: 1px solid #eee;
        }
        
        .slot {
            width: 56px;
            height: 64px;
            border-radius: 12px;
            border: 2px dashed #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            background: #fff;
            transition: background .2s, border-color .2s;
        }
        
        .slot.filled {
            border-style: solid;
            border-color: #a5b4fc;
            background: #eef2ff;
        }
        
        .tile {
            user-select: none;
            padding: 12px 16px;
            font-size: 26px;
            font-weight: 900;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: grab;
            box-shadow: var(--shadow);
            transition: transform .1s ease, border-color .2s, background .2s;
        }
        
        .tile:active {
            cursor: grabbing;
            transform: scale(.98);
        }
        
        .tile.dragging {
            opacity: .8;
        }
        
        .bank {
            background: #f1f5f9;
        }
        
        .result {
            margin-top: 10px;
            font-weight: 800;
            font-size: 20px;
            display: none;
            padding: 14px 16px;
            border-radius: 12px;
        }
        
        .result.ok {
            display: block;
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .result.bad {
            display: block;
            background: #fef2f2;
            color: #7f1d1d;
            border: 1px solid #fecaca;
        }
        
        .footer {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }
        
        .progress {
            --p: 0%;
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }
        
        .progress::after {
            content: "";
            position: absolute;
            inset: 0;
            width: var(--p);
            background: linear-gradient(90deg, #3a86ff, #22c55e);
        }
        
        .ribbon {
            position: fixed;
            inset-inline-end: 12px;
            inset-block-start: 12px;
            background: #fff;
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
            font-size: 13px;
            color: #111;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        dialog {
            border: 0;
            border-radius: 16px;
            padding: 0;
            box-shadow: var(--shadow);
            width: min(600px, 95vw);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-head {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #fff;
            font-family: inherit;
        }
        
        label {
            font-size: 14px;
            color: #374151;
        }
        
        .grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }
        
        .grid>div {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .tiny {
            font-size: 13px;
            color: var(--muted);
        }
        
        .level-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .level-card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            border: 2px solid #eee;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .level-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }
        
        .level-card.active {
            border-color: var(--accent);
            background: #f0f7ff;
        }
        
        .level-title {
            font-weight: 800;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .level-desc {
            font-size: 13px;
            color: var(--muted);
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            gap: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
    </style>
</head>

<body>

    <div class="app">

        <header class="row">

            <div>

                <div class="title">๐ฎ ูุนุจุฉ <span style="color:var(--accent)">ูููู ุงููููุฉ</span></div>

                <div class="sub">ุงุณุญุจ ุงูุญุฑูู ูุชูููู ุงููููุฉ ุงูุตุญูุญุฉ</div>

            </div>

            <div class="stats">

                <div class="chip">ุงููุณุชูู: <span id="levelNow">1</span></div>

                <div class="chip">ุงููุชูุฌุฉ: <span id="scoreNow">0</span> โญ</div>

                <button class="btn secondary" id="btnLevels">ูุงุฆูุฉ ุงููุณุชููุงุช</button>

                <button class="btn secondary" id="btnTeacher">ูุถุน ุงููุนููู</button>

            </div>

        </header>

        <div class="card board">
            <div class="hint">
                <div class="left">
                    <span>๐ก ุชูููุญ:</span>
                    <strong id="hintText">--</strong>
                </div>
                <div class="lvl">ุงููููุฉ: <span id="wordLen">0</span> ุญุฑูู</div>
            </div>

            <div class="slots" id="slots"></div>
            <div class="bank" id="bank"></div>

            <div class="result" id="result"></div>

            <div class="footer">
                <button class="btn" id="btnCheck">ุชุญูู โ</button>
                <div class="progress" id="progress"></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn secondary" id="btnHint">ุชูููุญ ุฒุงุฆุฏ ๐ช</button>
                    <button class="btn secondary" id="btnShuffle">ุฎูุท ุงูุญุฑูู ๐</button>
                    <button class="btn secondary" id="btnResetLevel">ุฅุนุงุฏุฉ ุงููุณุชูู โบ</button>
                    <button class="btn bad" id="btnReset">ุฅุนุงุฏุฉ โบ</button>
                    <button class="btn good" id="btnNext" disabled>ุงูุชุงูู โถ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="ribbon">๐ง ุชูุฏููู ูุญููุธ ุชููุงุฆููุง</div>

    <!-- ููุญุฉ ุงููุณุชููุงุช -->
    <dialog id="levelsDlg">
        <div class="modal-head">
            <strong>ุงุฎุชุฑ ุงููุณุชูู ุงูููุงุณุจ</strong>
            <button class="btn secondary" onclick="levelsDlg.close()">ุฅุบูุงู</button>
        </div>
        <div class="modal-body">
            <div class="level-selector" id="levelSelector">
                <div class="level-card" data-level="1">
                    <div class="level-title">ุงููุณุชูู ุงูุฃูู</div>
                    <div class="level-desc">ุงูุญุฑูู: ุชุนุฑูู ุนูู ุงูุญุฑูู ุจุดูู ูููุตู</div>
                </div>
                <div class="level-card" data-level="2">
                    <div class="level-title">ุงููุณุชูู ุงูุซุงูู</div>
                    <div class="level-desc">ูููุงุช ูุตูุฑุฉ: ูููุงุช ูู 3 ุฃุญุฑู</div>
                </div>
                <div class="level-card" data-level="3">
                    <div class="level-title">ุงููุณุชูู ุงูุซุงูุซ</div>
                    <div class="level-desc">ูููุงุช ุฃุทูู: ูููุงุช 4-5 ุฃุญุฑู</div>
                </div>
            </div>
            <div class="action-bar">
                <div class="action-buttons">
                    <button class="btn secondary" id="btnClearLevelProgress">ุฅุนุงุฏุฉ ุชุนููู ุงููุณุชูู ุงูุญุงูู</button>
                    <button class="btn secondary" id="btnClearAllProgress">ุฅุนุงุฏุฉ ุชุนููู ูู ุงูุชูุฏู</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- ููุญุฉ ุงููุนููู ูุฅุถุงูุฉ ูููุงุช -->
    <dialog id="teacherDlg">
        <div class="modal-head">
            <strong>ูุถุน ุงููุนููู (ุฅุถุงูุฉ ูููุงุช ุฌุฏูุฏุฉ)</strong>
            <button class="btn secondary" onclick="teacherDlg.close()">ุฅุบูุงู</button>
        </div>
        <div class="modal-body">
            <div class="tiny">ุฃุถููู ูููุงุช ููู ูุณุชูู ูุน ุชูููุญ ุจุณูุท. ุชูุญูุธ ูุญูููุง ูู ุงููุชุตูุญ.</div>
            <div class="grid">
                <div>
                    <label>ุงููููุฉ (ุนุฑุจู):</label>
                    <input id="tWord" placeholder="ูุซุงู: ูุฏุฑุณุฉ">
                </div>
                <div>
                    <label>ุชูููุญ (ุตูุฑุฉ/ุตูู/ุฌููุฉ ูุตูุฑุฉ):</label>
                    <input id="tHint" placeholder="๐ซ ููุงู ููุชุนูู">
                </div>
            </div>
            <div class="grid" style="margin-top:10px;">
                <div>
                    <label>ุงููุณุชูู:</label>
                    <select id="tLevel">
        <option value="1">1 (ุงูุญุฑูู)</option>
        <option value="2">2 (ูููุงุช ูุตูุฑุฉ)</option>
        <option value="3">3 (ูููุงุช ุฃุทูู)</option>
      </select>
                </div>
                <div>
                    <label>ุญุฑูู ููุดูููุดุฉ (ุงุฎุชูุงุฑู):</label>
                    <input id="tNoise" placeholder="ูุซุงู: ุซุุฐุุค">
                </div>
            </div>
            <div class="row" style="margin-top:12px;">
                <button class="btn" id="btnAddWord">ุฅุถุงูุฉ ุงููููุฉ โ</button>
                <button class="btn bad" id="btnClearAll">ุญุฐู ุงููููุงุช ุงููุถุงูุฉ ๐๏ธ</button>
            </div>
            <div class="tiny" style="margin-top:8px;">ูุตูุญุฉ: ุงุฌุนูู ุงูุชูููุญ ูุตูุฑูุง ููุญูู ุฑูุฒูุง ุชุนุจูุฑููุง ุฃู ูููุฉ ูู ุงูุจูุฆุฉ ุงูุตููุฉ.</div>
        </div>
    </dialog>

    <script>
        (() => {
            // ========== ุจูุงูุงุช ุงูุจุฏุงูุฉ ==========
            const builtInBank = {
                1: [{
                    w: "ุจ",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ุจุงุจ",
                    noise: "ุชุุซ"
                }, {
                    w: "ุช",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ุชูุงุญ",
                    noise: "ุซุุจ"
                }, {
                    w: "ุง",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ุฃุณุฏ",
                    noise: "ูุู"
                }, {
                    w: "ุน",
                    hint: "๐ฉ ุฃูู ุญุฑู ูู ูููุฉ ุนูู",
                    noise: "ุบุุญ"
                }, {
                    w: "ุณ",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ุณูู",
                    noise: "ุดุุต"
                }, {
                    w: "ุฏ",
                    hint: "๐ป ุฃูู ุญุฑู ูู ูููุฉ ุฏุจ",
                    noise: "ุฐุุฑ"
                }, {
                    w: "ุฑ",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ุฑุบูู",
                    noise: "ุฒุุฏ"
                }, {
                    w: "ุฌ",
                    hint: "๐ง ุฃูู ุญุฑู ูู ูููุฉ ุฌุจู",
                    noise: "ุญุุฎ"
                }, {
                    w: "ุญ",
                    hint: "๐ด ุฃูู ุญุฑู ูู ูููุฉ ุญุตุงู",
                    noise: "ุฎุุฌ"
                }, {
                    w: "ู",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ููู",
                    noise: "ูุู"
                }, {
                    w: "ู",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ูุฑุฉ",
                    noise: "ูุู"
                }, {
                    w: "ู",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ููููู",
                    noise: "ูุู"
                }, {
                    w: "ู",
                    hint: "๐ ุฃูู ุญุฑู ูู ูููุฉ ููู",
                    noise: "ุชุุจ"
                }],
                3: [{
                    w: "ููู",
                    hint: "โ๏ธ ููุชุจ ุจู",
                    noise: "ูุุฐ"
                }, {
                    w: "ุจุงุจ",
                    hint: "๐ช ูุฏุฎู ููู",
                    noise: "ุชุุฑ"
                }, {
                    w: "ูุฏ",
                    hint: "๐ ููุณู ุจูุง ุงูุฃุดูุงุก",
                    noise: "ุฑุู"
                }, {
                    w: "ูู",
                    hint: "๐ ูุฃูู ุจู",
                    noise: "ูุุฎ"
                }, {
                    w: "ุฃุจ",
                    hint: "๐จ ูุงูุฏ",
                    noise: "ูุุฌ"
                }, {
                    w: "ุฃู",
                    hint: "๐ฉ ูุงูุฏุฉ",
                    noise: "ุจุุฎ"
                }, {
                    w: "ุฏุจ",
                    hint: "๐ป ุญููุงู ุจูู",
                    noise: "ุฐุุต"
                }, {
                    w: "ููู",
                    hint: "๐ ูู ุฎุฑุทูู ุทููู",
                    noise: "ุฏุุต"
                }, {
                    w: "ุจูุช",
                    hint: "๐ ูุณูู ููู",
                    noise: "ุซุุท"
                }, {
                    w: "ููู",
                    hint: "๐ ุญุดุฑุงุช ุตุบูุฑุฉ",
                    noise: "ุจุุญ"
                }, {
                    w: "ุฃุณุฏ",
                    hint: "๐ฆ ููู ุงูุบุงุจุฉ",
                    noise: "ุฐุุท"
                }, {
                    w: "ุชุงุฌ",
                    hint: "๐ ูุถุนู ุงูููู",
                    noise: "ุญุู"
                }, {
                    w: "ุฌูู",
                    hint: "๐ช ุญููุงู ุงูุตุญุฑุงุก",
                    noise: "ุญุู"
                }, {
                    w: "ุฑูู",
                    hint: "๐๏ธ ูุบุทู ุงูุตุญุฑุงุก",
                    noise: "ุฒุู"
                }, {
                    w: "ููู",
                    hint: "๐ ููุช ุงูููู",
                    noise: "ูุู"
                }, {
                    w: "ุชูู",
                    hint: "๐ ูุงููุฉ ุญููุฉ",
                    noise: "ุซุุฑ"
                }, {
                    w: "ุนูุจ",
                    hint: "๐ ูุงููุฉ ุญููุฉ",
                    noise: "ุบุู"
                }, {
                    w: "ููู",
                    hint: "๐ฅ ุทุนุงู ุตุจุงุญู",
                    noise: "ูุุฎ"
                }, {
                    w: "ุฏุฑุณ",
                    hint: "๐ ูุชุนููู ูู ุงููุฏุฑุณุฉ",
                    noise: "ุฒุุต"
                }, {
                    w: "ูุฑุฉ",
                    hint: "โฝ ููุนุจ ุจูุง",
                    noise: "ูุุณ"
                }],
                2: [{
                    w: "ูุชุงุจ",
                    hint: "๐ ููุฑุฃ ููู",
                    noise: "ุญุุฐ"
                }, {
                    w: "ููู",
                    hint: "โ๏ธ ููุชุจ ุจู",
                    noise: "ุทุุต"
                }, {
                    w: "ุจุงุจ",
                    hint: "๐ช ูุฏุฎู ููู",
                    noise: "ุชุุฐ"
                }, {
                    w: "ูุงูุฐุฉ",
                    hint: "๐ช ูุฏุฎู ูููุง ุงูููุฑ",
                    noise: "ุตุุจ"
                }, {
                    w: "ุดุฌุฑุฉ",
                    hint: "๐ณ ุชููู ูู ุงูุญุฏููุฉ",
                    noise: "ุซุุถ"
                }, {
                    w: "ุทุงููุฉ",
                    hint: "๐ช ูุถุน ุนูููุง ุงูุทุนุงู",
                    noise: "ุตุุธ"
                }, {
                    w: "ุณููุฉ",
                    hint: "๐ ุชุนูุด ูู ุงููุงุก",
                    noise: "ุทุู"
                }, {
                    w: "ูุฑุฏุฉ",
                    hint: "๐น ุฒูุฑุฉ ุฌูููุฉ",
                    noise: "ุฌุู"
                }, {
                    w: "ุณุงุนุฉ",
                    hint: "โฐ ุชุฎุจุฑูุง ุจุงูููุช",
                    noise: "ูุู"
                }, {
                    w: "ูุฏุฑุณุฉ",
                    hint: "๐ซ ููุงู ููุชุนูู",
                    noise: "ุซุุฐ"
                }, {
                    w: "ูุนููุฉ",
                    hint: "๐ฉโ๐ซ ุชูุฏุฑูุณูุง",
                    noise: "ุฌุุฎ"
                }, {
                    w: "ุญุฏููุฉ",
                    hint: "๐ณ ููุนุจ ูููุง",
                    noise: "ูุุบ"
                }, {
                    w: "ุทุจูุจ",
                    hint: "๐จโโ๏ธ ูุนุงูุฌ ุงููุฑุถู",
                    noise: "ุตุู"
                }, {
                    w: "ูุฑุณู",
                    hint: "๐ช ูุฌูุณ ุนููู",
                    noise: "ุทุู"
                }, {
                    w: "ุชูุงุญ",
                    hint: "๐ ูุงููุฉ ุญูุฑุงุก",
                    noise: "ุซุุฌ"
                }, {
                    w: "ุจุฑุชูุงู",
                    hint: "๐ ูุงููุฉ ุจุฑุชูุงููุฉ",
                    noise: "ุซุู"
                }, {
                    w: "ุญููุจุฉ",
                    hint: "๐ ูุญูู ูููุง ุงููุชุจ",
                    noise: "ุฎุุฐ"
                }, {
                    w: "ุทุนุงู",
                    hint: "๐ฒ ูุชูุงููู ููุบุฐุงุก",
                    noise: "ุธุู"
                }, {
                    w: "ูุณุฌุฏ",
                    hint: "๐ ููุงู ููุนุจุงุฏุฉ",
                    noise: "ุตุุฎ"
                }, {
                    w: "ููุฑ",
                    hint: "๐ ูุถูุก ูู ุงูููู",
                    noise: "ูุุณ"
                }, {
                    w: "ุดูุณ",
                    hint: "โ๏ธ ุชุดุฑู ูู ุตุจุงุญ",
                    noise: "ุตุุซ"
                }, {
                    w: "ูุงุชู",
                    hint: "๐ฑ ูุชุญุฏุซ ุจู",
                    noise: "ุทุุฎ"
                }]
            };

            // ุชุญููู ูููุงุช ุงููุนููู ูู ุงูุชุฎุฒูู
            const teacherKey = "wb_teacher_words_v2";

            function loadTeacherWords() {
                try {
                    return JSON.parse(localStorage.getItem(teacherKey) || "{}");
                } catch {
                    return {};
                }
            }

            function saveTeacherWords(data) {
                localStorage.setItem(teacherKey, JSON.stringify(data || {}));
            }

            // ุฏูุฌ ุงูุจููู
            function getFullBank() {
                const t = loadTeacherWords();
                const merged = {
                    1: [...builtInBank[1]],
                    2: [...builtInBank[2]],
                    3: [...builtInBank[3]]
                };
                for (const lvl of[1, 2, 3]) {
                    if (t[lvl]) merged[lvl].push(...t[lvl]);
                }
                return merged;
            }

            // ุญุงูุฉ ุงููุนุจุฉ
            const stateKey = "wb_state_v2";
            const state = loadState();

            function loadState() {
                try {
                    return JSON.parse(localStorage.getItem(stateKey)) || {
                        level: 1,
                        score: 0,
                        done: {}
                    };
                } catch {
                    return {
                        level: 1,
                        score: 0,
                        done: {}
                    };
                }
            }

            function saveState() {
                localStorage.setItem(stateKey, JSON.stringify(state));
            }

            // ุนูุงุตุฑ DOM
            const el = {
                levelNow: document.getElementById("levelNow"),
                scoreNow: document.getElementById("scoreNow"),
                hintText: document.getElementById("hintText"),
                wordLen: document.getElementById("wordLen"),
                slots: document.getElementById("slots"),
                bank: document.getElementById("bank"),
                result: document.getElementById("result"),
                btnCheck: document.getElementById("btnCheck"),
                btnReset: document.getElementById("btnReset"),
                btnResetLevel: document.getElementById("btnResetLevel"),
                btnShuffle: document.getElementById("btnShuffle"),
                btnHint: document.getElementById("btnHint"),
                btnNext: document.getElementById("btnNext"),
                progress: document.getElementById("progress"),
                btnTeacher: document.getElementById("btnTeacher"),
                btnLevels: document.getElementById("btnLevels"),
                teacherDlg: document.getElementById("teacherDlg"),
                levelsDlg: document.getElementById("levelsDlg"),
                levelSelector: document.getElementById("levelSelector"),
                btnClearLevelProgress: document.getElementById("btnClearLevelProgress"),
                btnClearAllProgress: document.getElementById("btnClearAllProgress"),
                tWord: document.getElementById("tWord"),
                tHint: document.getElementById("tHint"),
                tLevel: document.getElementById("tLevel"),
                tNoise: document.getElementById("tNoise"),
                btnAddWord: document.getElementById("btnAddWord"),
                btnClearAll: document.getElementById("btnClearAll"),
            };

            // ุตูุช ุงููุฌุงุญ - ุชู ุชุบููุฑู
            function playSoundSuccess() {
                // ุงุณุชุฎุฏุงู ุฃุฏุงุฉ WebAudio API ูุฅูุดุงุก ุตูุช ุฃูุซุฑ ุณูุงุณุฉ ูุฃูู ุฅุฒุนุงุฌูุง
                const ctx = new(window.AudioContext || window.webkitAudioContext)();

                // ุฅูุดุงุก ูุบูุฉ ููุณูููุฉ ูุฑูุญุฉ
                const notes = [523.25, 659.25, 783.99]; // ูุบูุงุช ุฏู-ูู-ุตูู

                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.type = 'sine';
                    osc.frequency.value = freq;

                    gain.gain.value = 0.08; // ุฎูุถ ูุณุชูู ุงูุตูุช

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.start(ctx.currentTime + i * 0.1);
                    osc.stop(ctx.currentTime + i * 0.1 + 0.2);

                    // ุชูุงุดู ุงูุตูุช
                    gain.gain.exponentialRampToValueAtTime(
                        0.001, ctx.currentTime + i * 0.1 + 0.3
                    );
                });
            }

            // ุตูุช ุจุณูุท (WebAudio) - ููุฃุตูุงุช ุงูุฃุฎุฑู
            const ctx = new(window.AudioContext || window.webkitAudioContext)();

            function beep(freq = 880, ms = 120, type = "sine", vol = 0.03) {
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = type;
                o.frequency.value = freq;
                g.gain.value = vol;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => {
                    o.stop();
                }, ms);
            }

            // ุฃุฏุงุฉ ุนุดูุงุฆูุฉ
            const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(p => p[1]);

            // ูุนุจุฉ ุงูุฌููุฉ ุงูุญุงููุฉ
            let current = null; // {word, hint, letters[], distractors[]}

            function pickWord() {
                const bank = getFullBank()[state.level] || [];
                if (!state.done[state.level]) {
                    state.done[state.level] = [];
                }

                // ุชุฌููุจ ุชูุฑุงุฑ ููุณ ุงููููุฉ
                const candidates = bank.filter(x => !state.done[state.level].includes(x.w));
                if (candidates.length === 0) {
                    // ุฅุนุงุฏุฉ ุชุนููู ุงููููุงุช ุงูููุฌุฒุฉ ูู ูุฐุง ุงููุณุชูู
                    state.done[state.level] = [];
                    saveState();
                    return pickWord();
                }

                const chosen = rand(candidates);
                const word = chosen.w.replace(/\s+/g, ""); // ุจุฏูู ูุณุงูุงุช
                const letters = [...word]; // ุฃุญุฑู ุฃุตููุฉ

                // ููุดูููุดุงุช
                let noise = [];
                if (chosen.noise) {
                    noise = chosen.noise.split(/[,ุ\/]/).map(s => s.trim()).filter(Boolean);
                } else {
                    // ุชูููุฏ ููุดูููุด ุชููุงุฆู ูู ุฃุญุฑู ุนุฑุจูุฉ ุดุงุฆุนุฉ
                    const pool = "ุงุจุชุซุฌุญุฎุฏุฐุฑุฒุณุดุตุถุทุธุนุบูููููููููุฉุก";
                    while (noise.length < Math.min(3, Math.max(0, 6 - letters.length))) {
                        const n = pool[Math.floor(Math.random() * pool.length)];
                        if (!letters.includes(n)) noise.push(n);
                    }
                }
                current = {
                    word: word,
                    fullWord: chosen.w,
                    hint: chosen.hint || "--",
                    letters,
                    noise
                };
                renderRound();
            }

            function renderRound() {
                el.result.className = "result";
                el.result.style.display = "none";
                el.btnNext.disabled = true;

                el.levelNow.textContent = state.level;
                el.scoreNow.textContent = state.score;
                el.hintText.textContent = current.hint;
                el.wordLen.textContent = current.letters.length;
                el.progress.style.setProperty("--p", progressPercent() + "%");

                // ูุฑุงุบุงุช slots
                el.slots.innerHTML = "";
                current.letters.forEach((_, i) => {
                    const s = document.createElement("div");
                    s.className = "slot";
                    s.dataset.index = i;
                    s.addEventListener("dragover", ev => ev.preventDefault());
                    s.addEventListener("drop", onDropToSlot);
                    el.slots.appendChild(s);
                });

                // ุจูู ุงูุญุฑูู
                el.bank.innerHTML = "";
                const tiles = shuffle([...current.letters, ...current.noise]);
                tiles.forEach(ch => el.bank.appendChild(makeTile(ch)));
            }

            function makeTile(ch) {
                const t = document.createElement("div");
                t.className = "tile";
                t.draggable = true;
                t.textContent = ch;
                t.dataset.letter = ch;
                t.addEventListener("dragstart", ev => {
                    t.classList.add("dragging");
                    ev.dataTransfer.setData("text/plain", ch);
                    // ูุถุน ูุนุฑู ุงูุนูุตุฑ ููุณุชุทูุน ุฅุฑุฌุงุนู
                    ev.dataTransfer.setData("text/id", Date.now() + "_" + Math.random());
                    // ูุฎุฒู ูุฑุฌุน ุงูุนูุตุฑ ููุณู
                    window.__draggingTile = t;
                });
                t.addEventListener("dragend", () => t.classList.remove("dragging"));
                t.addEventListener("dblclick", () => { // ููุฑ ูุฒุฏูุฌ ูุนูุฏู ููุจูู/ููุฑุบ
                    if (t.parentElement && t.parentElement.classList.contains("slot")) {
                        t.parentElement.classList.remove("filled");
                    }
                    el.bank.appendChild(t);
                });
                t.addEventListener("click", () => {
                    // ุจุญุซ ุนู ุฃูู ุณููุช ูุงุฑุบ
                    const emptySlot = [...el.slots.children].find(s => !s.firstElementChild);
                    if (emptySlot) {
                        if (t.parentElement && t.parentElement.classList.contains("slot")) {
                            t.parentElement.classList.remove("filled");
                        }
                        emptySlot.appendChild(t);
                        emptySlot.classList.add("filled");
                        beep(900, 60, "triangle", .02);
                    }
                });
                return t;
            }

            function onDropToSlot(ev) {
                ev.preventDefault();
                const slot = ev.currentTarget;
                const tile = window.__draggingTile;
                if (!tile) return;

                // ูู ูุงู ูู ุงูุณููุช ุญุฑู ูุณุจูุงูุ ูุฑุฌุนู ููุจูู
                if (slot.firstElementChild) {
                    el.bank.appendChild(slot.firstElementChild);
                }
                slot.innerHTML = "";
                slot.appendChild(tile);
                slot.classList.add("filled");
                beep(900, 60, "triangle", .02);
            }

            function collectAnswer() {
                const letters = [...el.slots.children].map(s => s.firstElementChild ? s.firstElementChild.dataset.letter : "");
                return letters.join("");
            }

            function showResult(ok, msg) {
                el.result.className = "result " + (ok ? "ok" : "bad");
                el.result.textContent = msg;
                el.result.style.display = "block";
            }

            function progressPercent() {
                if (!state.done[state.level]) return 0;

                const bank = getFullBank()[state.level] || [];
                const total = bank.length || 1;
                const done = state.done[state.level].length;
                return Math.round(100 * done / total);
            }

            function check() {
                const ans = collectAnswer();
                if (ans.length !== current.letters.length) {
                    beep(200, 150, "sawtooth", .03);
                    return showResult(false, "ููููู ุฌููุน ุงูุญุฑูู ุฃููุงู ๐");
                }

                // ููุฌูู ูุงููููุงุช ุงููุนูุฏุฉุ ูุชุญูู ูู ุงููููุฉ ุงููุงููุฉ ุจุฏูู ุงููุณุงูุงุช
                if (ans === current.word) {
                    // ุตุญูุญ
                    showResult(true, "๐ ุฃุญุณูุชู! ุฅุฌุงุจุฉ ุตุญูุญุฉ");
                    el.btnNext.disabled = false;
                    state.score += 5;
                    // ูุณููู ุงููููุฉ ููุฌุฒุฉ
                    if (!state.done[state.level]) {
                        state.done[state.level] = [];
                    }
                    if (!state.done[state.level].includes(current.fullWord)) {
                        state.done[state.level].push(current.fullWord);
                    }
                    saveState();
                    confetti();

                    // ุงุณุชุฎุฏู ุตูุช ุงููุฌุงุญ ุงูุฌุฏูุฏ
                    playSoundSuccess();
                } else {
                    // ุฎุทุฃ
                    showResult(false, "โ ููุณุช ุตุญูุญุฉ. ุฌุฑูุจู ุฎูุท ุงูุญุฑูู ุฃู ุงุณุชุฎุฏูู ุชูููุญูุง ุฅุถุงูููุง.");
                    state.score = Math.max(0, state.score - 1);
                    saveState();
                    shake(el.slots);
                    beep(160, 220, "sine", .03);
                }
                el.scoreNow.textContent = state.score;
                el.progress.style.setProperty("--p", progressPercent() + "%");
            }

            function resetRound() {
                // ุฃุนูุฏ ูู ุงูุจูุงุทุงุช ููุจูู ูุฃูุฑุบ ุงูุฎุงูุงุช
                [...el.slots.children].forEach(s => {
                    if (s.firstElementChild) el.bank.appendChild(s.firstElementChild);
                    s.classList.remove("filled");
                });
                el.result.style.display = "none";
            }

            function resetLevel() {
                if (confirm("ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุนููู ุงููุณุชูู ุงูุญุงููุ")) {
                    if (state.done[state.level]) {
                        state.done[state.level] = [];
                        saveState();
                        resetRound();
                        pickWord();
                    }
                }
            }

            function extraHint() {
                // ููุดู ุญุฑููุง ุนุดูุงุฆููุง ุตุญูุญูุง ูู ูููุถุน ุจุนุฏ
                const emptyIdx = [...el.slots.children]
                    .map((s, i) => s.firstElementChild ? null : i)
                    .filter(i => i !== null);
                if (emptyIdx.length === 0) return;
                const i = rand(emptyIdx);
                const target = current.letters[i];

                // ุงุจุญุซู ุนู ุจูุงุทุฉ ุจุงูุญุฑู ุงููุฏู (ูุฏ ุชููู ูู ุงูุจูู ุฃู ูู ุฎุงูุฉ ุฎุงุทุฆุฉ)
                // 1) ูู ุงูุจูู
                let tile = [...el.bank.children].find(t => t.dataset.letter === target);
                // 2) ุฃู ูู ุฎุงูุฉ ุฎุงุทุฆุฉ
                if (!tile) {
                    const wrong = [...el.slots.children].find(s => s.firstElementChild && s.firstElementChild.dataset.letter === target && Number(s.dataset.index) !== i);
                    if (wrong) {
                        tile = wrong.firstElementChild;
                        wrong.classList.remove("filled");
                    }
                }
                if (tile) {
                    // ูู ูู ุงูุณููุช ุญุฑูุ ุฃุฑุฌุนูู ููุจูู
                    const slot = el.slots.children[i];
                    if (slot.firstElementChild) el.bank.appendChild(slot.firstElementChild);
                    slot.innerHTML = "";
                    slot.appendChild(tile);
                    slot.classList.add("filled");
                    beep(1000, 80, "triangle", .03);
                    showResult(false, "๐ช ุชู ุงููุดู ุนู ุญุฑู ูุงุญุฏ.");
                }
            }

            function shuffleBank() {
                const tiles = [...el.bank.children];
                const mixed = shuffle(tiles);
                mixed.forEach(t => el.bank.appendChild(t));
                beep(700, 60, "sine", .02);
            }

            function nextRound() {
                pickWord();
            }

            // ูุคุซุฑุงุช ุจุณูุทุฉ
            function shake(node) {
                node.animate([{
                    transform: "translateX(0)"
                }, {
                    transform: "translateX(-6px)"
                }, {
                    transform: "translateX(6px)"
                }, {
                    transform: "translateX(0)"
                }], {
                    duration: 220,
                    iterations: 1
                });
            }

            function confetti() {
                const n = 25,
                    dur = 1200;
                for (let i = 0; i < n; i++) {
                    const p = document.createElement("div");
                    p.style.position = "fixed";
                    p.style.width = "10px";
                    p.style.height = "10px";
                    p.style.background = `hsl(${Math.random()*360},90%,60%)`;
                    p.style.insetInlineStart = (Math.random() * 80 + 10) + "vw";
                    p.style.insetBlockStart = "0vh";
                    p.style.borderRadius = "2px";
                    p.style.transform = `rotate(${Math.random()*360}deg)`;
                    p.style.zIndex = 9999;
                    document.body.appendChild(p);
                    p.animate([{
                            transform: `translateY(0) rotate(0deg)`
                        }, {
                            transform: `translateY(80vh) rotate(${Math.random()*720-360}deg)`
                        }], {
                            duration: dur + Math.random() * 600,
                            easing: "cubic-bezier(.2,.7,.2,1)"
                        })
                        .onfinish = () => p.remove();
                }
            }

            // ุฅุนุฏุงุฏ ูุฎุชุงุฑ ุงููุณุชููุงุช
            function setupLevelSelector() {
                const levelCards = el.levelSelector.querySelectorAll('.level-card');
                levelCards.forEach(card => {
                    const level = parseInt(card.dataset.level);
                    card.addEventListener('click', () => {
                        levelCards.forEach(c => c.classList.remove('active'));
                        card.classList.add('active');

                        state.level = level;
                        if (!state.done[level]) {
                            state.done[level] = [];
                        }
                        saveState();
                        el.levelsDlg.close();
                        resetRound();
                        pickWord();
                    });

                    // ูุถุน ุนูุงูุฉ active ุนูู ุงููุณุชูู ุงูุญุงูู
                    if (level === state.level) {
                        card.classList.add('active');
                    }
                });
            }

            // ุฃุญุฏุงุซ ุงูุฃุฒุฑุงุฑ
            el.btnCheck.addEventListener("click", check);
            el.btnReset.addEventListener("click", resetRound);
            el.btnResetLevel.addEventListener("click", resetLevel);
            el.btnShuffle.addEventListener("click", shuffleBank);
            el.btnHint.addEventListener("click", extraHint);
            el.btnNext.addEventListener("click", nextRound);
            el.btnTeacher.addEventListener("click", () => el.teacherDlg.showModal());
            el.btnLevels.addEventListener("click", () => {
                setupLevelSelector();
                el.levelsDlg.showModal();
            });

            // ุฃุฒุฑุงุฑ ุฅุนุงุฏุฉ ุงูุชุนููู
            el.btnClearLevelProgress.addEventListener("click", () => {
                if (confirm(`ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุนููู ุงูุชูุฏู ูููุณุชูู ${state.level}ุ`)) {
                    if (state.done[state.level]) {
                        state.done[state.level] = [];
                        saveState();
                        alert(`ุชู ุฅุนุงุฏุฉ ุชุนููู ุงููุณุชูู ${state.level}`);
                        el.levelsDlg.close();
                        pickWord();
                    }
                }
            });

            el.btnClearAllProgress.addEventListener("click", () => {
                if (confirm("ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุนููู ูู ุงูุชูุฏู ูู ุฌููุน ุงููุณุชููุงุชุ")) {
                    state.done = {};
                    state.score = 0;
                    saveState();
                    alert("ุชู ุฅุนุงุฏุฉ ุชุนููู ูู ุงูุชูุฏู");
                    el.levelsDlg.close();
                    pickWord();
                }
            });

            // ูุถุน ุงููุนููู
            el.btnAddWord.addEventListener("click", () => {
                const w = (el.tWord.value || "").trim();
                const hint = (el.tHint.value || "").trim() || "--";
                const lvl = Number(el.tLevel.value || "1");
                const noise = (el.tNoise.value || "").trim();
                if (!w) {
                    alert("ุงูุชุจู ุงููููุฉ ุฃูููุง.");
                    return;
                }
                const data = loadTeacherWords();
                if (!data[lvl]) data[lvl] = [];
                data[lvl].push({
                    w,
                    hint,
                    noise
                });
                saveTeacherWords(data);
                el.tWord.value = "";
                el.tHint.value = "";
                el.tNoise.value = "";
                alert("ุชูุช ุงูุฅุถุงูุฉ โ ุณุชุธูุฑ ูู ุงููุณุชูู ุนูุฏ ุงูุชุดุบูู ุงูุชุงูู.");
            });

            el.btnClearAll.addEventListener("click", () => {
                if (confirm("ุญุฐู ูู ูููุงุช ุงููุนูููุ")) {
                    saveTeacherWords({});
                    alert("ุชู ุงูุญุฐู.");
                }
            });

            // ุชุญูู ูู ุงููุณุชูู ุงูุญุงูู - ุฅุฐุง ูุงู ุงููุณุชูู 2 ุฃู 5ุ ููุชูู ุฅูู ุงููุณุชูู 1
            if (state.level === 2 || state.level === 5) {
                state.level = 1;
                saveState();
            }

            // ุจุฏุก ุงููุนุจุฉ
            setupLevelSelector();
            pickWord();

        })();
    </script>
</body>

</html>