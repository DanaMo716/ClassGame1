<!doctype html>

<html lang="ar" dir="rtl">

<head>

    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>لعبة كوّن الكلمة - تعلّم العربية</title>

    <style>
         :root {
            --bg: #f7f7fb;
            --card: #ffffff;
            --ink: #222;
            --muted: #666;
            --accent: #3a86ff;
            --ok: #22c55e;
            --bad: #ef4444;
            --shadow: 0 8px 20px rgba(0, 0, 0, .08);
        }
        
        html,
        body {
            height: 100%;
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Amiri", "Cairo", Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .app {
            width: min(1100px, 100%);
        }
        
        header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .title {
            font-weight: 800;
            font-size: clamp(22px, 2.8vw, 32px);
        }
        
        .sub {
            color: var(--muted);
            font-size: 15px;
        }
        
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        
        .stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chip {
            background: #eef2ff;
            color: #1f3aed;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn {
            border: 0;
            padding: 12px 16px;
            border-radius: 10px;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(58, 134, 255, .3);
            transition: transform .05s ease;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.secondary {
            background: #e5e7eb;
            color: #111;
            box-shadow: none;
        }
        
        .btn.good {
            background: var(--ok);
            box-shadow: 0 4px 12px rgba(34, 197, 94, .25);
        }
        
        .btn.bad {
            background: var(--bad);
        }
        
        .board {
            display: grid;
            gap: 14px;
            margin-top: 10px;
            grid-template-columns: 1fr;
        }
        
        .hint {
            background: #f8fafc;
            border: 1px dashed #dbeafe;
            padding: 14px 16px;
            border-radius: 12px;
            color: #0f172a;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hint .left {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .lvl {
            font-weight: 700;
        }
        
        .slots,
        .bank {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            min-height: 80px;
            padding: 18px;
            border-radius: 14px;
            background: #fafafa;
            border: 1px solid #eee;
        }
        
        .slot {
            width: 56px;
            height: 64px;
            border-radius: 12px;
            border: 2px dashed #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            background: #fff;
            transition: background .2s, border-color .2s;
        }
        
        .slot.filled {
            border-style: solid;
            border-color: #a5b4fc;
            background: #eef2ff;
        }
        
        .tile {
            user-select: none;
            padding: 12px 16px;
            font-size: 26px;
            font-weight: 900;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: grab;
            box-shadow: var(--shadow);
            transition: transform .1s ease, border-color .2s, background .2s;
        }
        
        .tile:active {
            cursor: grabbing;
            transform: scale(.98);
        }
        
        .tile.dragging {
            opacity: .8;
        }
        
        .bank {
            background: #f1f5f9;
        }
        
        .result {
            margin-top: 10px;
            font-weight: 800;
            font-size: 20px;
            display: none;
            padding: 14px 16px;
            border-radius: 12px;
        }
        
        .result.ok {
            display: block;
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .result.bad {
            display: block;
            background: #fef2f2;
            color: #7f1d1d;
            border: 1px solid #fecaca;
        }
        
        .footer {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }
        
        .progress {
            --p: 0%;
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }
        
        .progress::after {
            content: "";
            position: absolute;
            inset: 0;
            width: var(--p);
            background: linear-gradient(90deg, #3a86ff, #22c55e);
        }
        
        .ribbon {
            position: fixed;
            inset-inline-end: 12px;
            inset-block-start: 12px;
            background: #fff;
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
            font-size: 13px;
            color: #111;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        dialog {
            border: 0;
            border-radius: 16px;
            padding: 0;
            box-shadow: var(--shadow);
            width: min(600px, 95vw);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-head {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #fff;
            font-family: inherit;
        }
        
        label {
            font-size: 14px;
            color: #374151;
        }
        
        .grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }
        
        .grid>div {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .tiny {
            font-size: 13px;
            color: var(--muted);
        }
        
        .level-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .level-card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            border: 2px solid #eee;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .level-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }
        
        .level-card.active {
            border-color: var(--accent);
            background: #f0f7ff;
        }
        
        .level-title {
            font-weight: 800;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .level-desc {
            font-size: 13px;
            color: var(--muted);
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            gap: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
    </style>
</head>

<body>

    <div class="app">

        <header class="row">

            <div>

                <div class="title">🎮 لعبة <span style="color:var(--accent)">كوّن الكلمة</span></div>

                <div class="sub">اسحب الحروف لتكوين الكلمة الصحيحة</div>

            </div>

            <div class="stats">

                <div class="chip">المستوى: <span id="levelNow">1</span></div>

                <div class="chip">النتيجة: <span id="scoreNow">0</span> ⭐</div>

                <button class="btn secondary" id="btnLevels">قائمة المستويات</button>

                <button class="btn secondary" id="btnTeacher">وضع المعلّم</button>

            </div>

        </header>

        <div class="card board">
            <div class="hint">
                <div class="left">
                    <span>💡 تلميح:</span>
                    <strong id="hintText">--</strong>
                </div>
                <div class="lvl">الكلمة: <span id="wordLen">0</span> حروف</div>
            </div>

            <div class="slots" id="slots"></div>
            <div class="bank" id="bank"></div>

            <div class="result" id="result"></div>

            <div class="footer">
                <button class="btn" id="btnCheck">تحقق ✅</button>
                <div class="progress" id="progress"></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn secondary" id="btnHint">تلميح زائد 🪄</button>
                    <button class="btn secondary" id="btnShuffle">خلط الحروف 🔀</button>
                    <button class="btn secondary" id="btnResetLevel">إعادة المستوى ↺</button>
                    <button class="btn bad" id="btnReset">إعادة ↺</button>
                    <button class="btn good" id="btnNext" disabled>التالي ▶</button>
                </div>
            </div>
        </div>
    </div>

    <div class="ribbon">🧠 تقدّمك محفوظ تلقائيًا</div>

    <!-- لوحة المستويات -->
    <dialog id="levelsDlg">
        <div class="modal-head">
            <strong>اختر المستوى المناسب</strong>
            <button class="btn secondary" onclick="levelsDlg.close()">إغلاق</button>
        </div>
        <div class="modal-body">
            <div class="level-selector" id="levelSelector">
                <div class="level-card" data-level="1">
                    <div class="level-title">المستوى الأول</div>
                    <div class="level-desc">الحروف: تعرّف على الحروف بشكل منفصل</div>
                </div>
                <div class="level-card" data-level="2">
                    <div class="level-title">المستوى الثاني</div>
                    <div class="level-desc">كلمات قصيرة: كلمات من 3 أحرف</div>
                </div>
                <div class="level-card" data-level="3">
                    <div class="level-title">المستوى الثالث</div>
                    <div class="level-desc">كلمات أطول: كلمات 4-5 أحرف</div>
                </div>
            </div>
            <div class="action-bar">
                <div class="action-buttons">
                    <button class="btn secondary" id="btnClearLevelProgress">إعادة تعيين المستوى الحالي</button>
                    <button class="btn secondary" id="btnClearAllProgress">إعادة تعيين كل التقدم</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- لوحة المعلّم لإضافة كلمات -->
    <dialog id="teacherDlg">
        <div class="modal-head">
            <strong>وضع المعلّم (إضافة كلمات جديدة)</strong>
            <button class="btn secondary" onclick="teacherDlg.close()">إغلاق</button>
        </div>
        <div class="modal-body">
            <div class="tiny">أضيفي كلمات لكل مستوى مع تلميح بسيط. تُحفظ محليًا في المتصفح.</div>
            <div class="grid">
                <div>
                    <label>الكلمة (عربي):</label>
                    <input id="tWord" placeholder="مثال: مدرسة">
                </div>
                <div>
                    <label>تلميح (صورة/صنف/جملة قصيرة):</label>
                    <input id="tHint" placeholder="🏫 مكان للتعلم">
                </div>
            </div>
            <div class="grid" style="margin-top:10px;">
                <div>
                    <label>المستوى:</label>
                    <select id="tLevel">
        <option value="1">1 (الحروف)</option>
        <option value="2">2 (كلمات قصيرة)</option>
        <option value="3">3 (كلمات أطول)</option>
      </select>
                </div>
                <div>
                    <label>حروف مُشوِّشة (اختياري):</label>
                    <input id="tNoise" placeholder="مثال: ث،ذ،ؤ">
                </div>
            </div>
            <div class="row" style="margin-top:12px;">
                <button class="btn" id="btnAddWord">إضافة الكلمة ➕</button>
                <button class="btn bad" id="btnClearAll">حذف الكلمات المضافة 🗑️</button>
            </div>
            <div class="tiny" style="margin-top:8px;">نصيحة: اجعلي التلميح قصيرًا ويحوي رمزًا تعبيريًا أو كلمة من البيئة الصفية.</div>
        </div>
    </dialog>

    <script>
        (() => {
            // ========== بيانات البداية ==========
            const builtInBank = {
                1: [{
                    w: "ب",
                    hint: "📘 أول حرف في كلمة باب",
                    noise: "ت،ث"
                }, {
                    w: "ت",
                    hint: "🍎 أول حرف في كلمة تفاح",
                    noise: "ث،ب"
                }, {
                    w: "ا",
                    hint: "🏠 أول حرف في كلمة أسد",
                    noise: "و،ي"
                }, {
                    w: "ع",
                    hint: "🚩 أول حرف في كلمة علم",
                    noise: "غ،ح"
                }, {
                    w: "س",
                    hint: "🐟 أول حرف في كلمة سمك",
                    noise: "ش،ص"
                }, {
                    w: "د",
                    hint: "🐻 أول حرف في كلمة دب",
                    noise: "ذ،ر"
                }, {
                    w: "ر",
                    hint: "🍞 أول حرف في كلمة رغيف",
                    noise: "ز،د"
                }, {
                    w: "ج",
                    hint: "🧀 أول حرف في كلمة جبن",
                    noise: "ح،خ"
                }, {
                    w: "ح",
                    hint: "🐴 أول حرف في كلمة حصان",
                    noise: "خ،ج"
                }, {
                    w: "ق",
                    hint: "📝 أول حرف في كلمة قلم",
                    noise: "ك،ف"
                }, {
                    w: "ك",
                    hint: "🏀 أول حرف في كلمة كرة",
                    noise: "ق،ل"
                }, {
                    w: "ل",
                    hint: "🍋 أول حرف في كلمة ليمون",
                    noise: "ك،م"
                }, {
                    w: "ن",
                    hint: "🐜 أول حرف في كلمة نمل",
                    noise: "ت،ب"
                }],
                3: [{
                    w: "قلم",
                    hint: "✏️ نكتب به",
                    noise: "ن،ذ"
                }, {
                    w: "باب",
                    hint: "🚪 ندخل منه",
                    noise: "ت،ر"
                }, {
                    w: "يد",
                    hint: "👋 نمسك بها الأشياء",
                    noise: "ر،ل"
                }, {
                    w: "فم",
                    hint: "👄 نأكل به",
                    noise: "ق،خ"
                }, {
                    w: "أب",
                    hint: "👨 والد",
                    noise: "م،ج"
                }, {
                    w: "أم",
                    hint: "👩 والدة",
                    noise: "ب،خ"
                }, {
                    w: "دب",
                    hint: "🐻 حيوان بني",
                    noise: "ذ،ص"
                }, {
                    w: "فيل",
                    hint: "🐘 له خرطوم طويل",
                    noise: "د،ص"
                }, {
                    w: "بيت",
                    hint: "🏠 نسكن فيه",
                    noise: "ث،ط"
                }, {
                    w: "نمل",
                    hint: "🐜 حشرات صغيرة",
                    noise: "ب،ح"
                }, {
                    w: "أسد",
                    hint: "🦁 ملك الغابة",
                    noise: "ذ،ط"
                }, {
                    w: "تاج",
                    hint: "👑 يضعه الملك",
                    noise: "ح،ك"
                }, {
                    w: "جمل",
                    hint: "🐪 حيوان الصحراء",
                    noise: "ح،ف"
                }, {
                    w: "رمل",
                    hint: "🏝️ يغطي الصحراء",
                    noise: "ز،ن"
                }, {
                    w: "ليل",
                    hint: "🌙 وقت النوم",
                    noise: "م،ه"
                }, {
                    w: "تين",
                    hint: "🍇 فاكهة حلوة",
                    noise: "ث،ر"
                }, {
                    w: "عنب",
                    hint: "🍇 فاكهة حلوة",
                    noise: "غ،ق"
                }, {
                    w: "فول",
                    hint: "🥜 طعام صباحي",
                    noise: "ق،خ"
                }, {
                    w: "درس",
                    hint: "📚 نتعلمه في المدرسة",
                    noise: "ز،ص"
                }, {
                    w: "كرة",
                    hint: "⚽ نلعب بها",
                    noise: "ق،س"
                }],
                2: [{
                    w: "كتاب",
                    hint: "📘 نقرأ فيه",
                    noise: "ح،ذ"
                }, {
                    w: "قلم",
                    hint: "✏️ نكتب به",
                    noise: "ط،ص"
                }, {
                    w: "باب",
                    hint: "🚪 ندخل منه",
                    noise: "ت،ذ"
                }, {
                    w: "نافذة",
                    hint: "🪟 يدخل منها النور",
                    noise: "ص،ب"
                }, {
                    w: "شجرة",
                    hint: "🌳 تنمو في الحديقة",
                    noise: "ث،ض"
                }, {
                    w: "طاولة",
                    hint: "🪑 نضع عليها الطعام",
                    noise: "ص،ظ"
                }, {
                    w: "سمكة",
                    hint: "🐟 تعيش في الماء",
                    noise: "ط،ك"
                }, {
                    w: "وردة",
                    hint: "🌹 زهرة جميلة",
                    noise: "ج،ق"
                }, {
                    w: "ساعة",
                    hint: "⏰ تخبرنا بالوقت",
                    noise: "ق،ه"
                }, {
                    w: "مدرسة",
                    hint: "🏫 مكان للتعلم",
                    noise: "ث،ذ"
                }, {
                    w: "معلمة",
                    hint: "👩‍🏫 تُدرّسنا",
                    noise: "ج،خ"
                }, {
                    w: "حديقة",
                    hint: "🌳 نلعب فيها",
                    noise: "ق،غ"
                }, {
                    w: "طبيب",
                    hint: "👨‍⚕️ يعالج المرضى",
                    noise: "ص،ك"
                }, {
                    w: "كرسي",
                    hint: "🪑 نجلس عليه",
                    noise: "ط،ل"
                }, {
                    w: "تفاح",
                    hint: "🍎 فاكهة حمراء",
                    noise: "ث،ج"
                }, {
                    w: "برتقال",
                    hint: "🍊 فاكهة برتقالية",
                    noise: "ث،ن"
                }, {
                    w: "حقيبة",
                    hint: "🎒 نحمل فيها الكتب",
                    noise: "خ،ذ"
                }, {
                    w: "طعام",
                    hint: "🍲 نتناوله للغذاء",
                    noise: "ظ،ف"
                }, {
                    w: "مسجد",
                    hint: "🕌 مكان للعبادة",
                    noise: "ص،خ"
                }, {
                    w: "قمر",
                    hint: "🌙 يضيء في الليل",
                    noise: "ك،س"
                }, {
                    w: "شمس",
                    hint: "☀️ تشرق كل صباح",
                    noise: "ص،ث"
                }, {
                    w: "هاتف",
                    hint: "📱 نتحدث به",
                    noise: "ط،خ"
                }]
            };

            // تحميل كلمات المعلّم من التخزين
            const teacherKey = "wb_teacher_words_v2";

            function loadTeacherWords() {
                try {
                    return JSON.parse(localStorage.getItem(teacherKey) || "{}");
                } catch {
                    return {};
                }
            }

            function saveTeacherWords(data) {
                localStorage.setItem(teacherKey, JSON.stringify(data || {}));
            }

            // دمج البنوك
            function getFullBank() {
                const t = loadTeacherWords();
                const merged = {
                    1: [...builtInBank[1]],
                    2: [...builtInBank[2]],
                    3: [...builtInBank[3]]
                };
                for (const lvl of[1, 2, 3]) {
                    if (t[lvl]) merged[lvl].push(...t[lvl]);
                }
                return merged;
            }

            // حالة اللعبة
            const stateKey = "wb_state_v2";
            const state = loadState();

            function loadState() {
                try {
                    return JSON.parse(localStorage.getItem(stateKey)) || {
                        level: 1,
                        score: 0,
                        done: {}
                    };
                } catch {
                    return {
                        level: 1,
                        score: 0,
                        done: {}
                    };
                }
            }

            function saveState() {
                localStorage.setItem(stateKey, JSON.stringify(state));
            }

            // عناصر DOM
            const el = {
                levelNow: document.getElementById("levelNow"),
                scoreNow: document.getElementById("scoreNow"),
                hintText: document.getElementById("hintText"),
                wordLen: document.getElementById("wordLen"),
                slots: document.getElementById("slots"),
                bank: document.getElementById("bank"),
                result: document.getElementById("result"),
                btnCheck: document.getElementById("btnCheck"),
                btnReset: document.getElementById("btnReset"),
                btnResetLevel: document.getElementById("btnResetLevel"),
                btnShuffle: document.getElementById("btnShuffle"),
                btnHint: document.getElementById("btnHint"),
                btnNext: document.getElementById("btnNext"),
                progress: document.getElementById("progress"),
                btnTeacher: document.getElementById("btnTeacher"),
                btnLevels: document.getElementById("btnLevels"),
                teacherDlg: document.getElementById("teacherDlg"),
                levelsDlg: document.getElementById("levelsDlg"),
                levelSelector: document.getElementById("levelSelector"),
                btnClearLevelProgress: document.getElementById("btnClearLevelProgress"),
                btnClearAllProgress: document.getElementById("btnClearAllProgress"),
                tWord: document.getElementById("tWord"),
                tHint: document.getElementById("tHint"),
                tLevel: document.getElementById("tLevel"),
                tNoise: document.getElementById("tNoise"),
                btnAddWord: document.getElementById("btnAddWord"),
                btnClearAll: document.getElementById("btnClearAll"),
            };

            // صوت النجاح - تم تغييره
            function playSoundSuccess() {
                // استخدام أداة WebAudio API لإنشاء صوت أكثر سلاسة وأقل إزعاجًا
                const ctx = new(window.AudioContext || window.webkitAudioContext)();

                // إنشاء نغمة موسيقية مريحة
                const notes = [523.25, 659.25, 783.99]; // نغمات دو-مي-صول

                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.type = 'sine';
                    osc.frequency.value = freq;

                    gain.gain.value = 0.08; // خفض مستوى الصوت

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.start(ctx.currentTime + i * 0.1);
                    osc.stop(ctx.currentTime + i * 0.1 + 0.2);

                    // تلاشي الصوت
                    gain.gain.exponentialRampToValueAtTime(
                        0.001, ctx.currentTime + i * 0.1 + 0.3
                    );
                });
            }

            // صوت بسيط (WebAudio) - للأصوات الأخرى
            const ctx = new(window.AudioContext || window.webkitAudioContext)();

            function beep(freq = 880, ms = 120, type = "sine", vol = 0.03) {
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = type;
                o.frequency.value = freq;
                g.gain.value = vol;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => {
                    o.stop();
                }, ms);
            }

            // أداة عشوائية
            const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(p => p[1]);

            // لعبة الجولة الحالية
            let current = null; // {word, hint, letters[], distractors[]}

            function pickWord() {
                const bank = getFullBank()[state.level] || [];
                if (!state.done[state.level]) {
                    state.done[state.level] = [];
                }

                // تجنّب تكرار نفس الكلمة
                const candidates = bank.filter(x => !state.done[state.level].includes(x.w));
                if (candidates.length === 0) {
                    // إعادة تعيين الكلمات المنجزة في هذا المستوى
                    state.done[state.level] = [];
                    saveState();
                    return pickWord();
                }

                const chosen = rand(candidates);
                const word = chosen.w.replace(/\s+/g, ""); // بدون مسافات
                const letters = [...word]; // أحرف أصلية

                // مُشوِّشات
                let noise = [];
                if (chosen.noise) {
                    noise = chosen.noise.split(/[,،\/]/).map(s => s.trim()).filter(Boolean);
                } else {
                    // توليد مُشوِّش تلقائي من أحرف عربية شائعة
                    const pool = "ابتثجحخدذرزسشصضطظعغفقكلمنهويةء";
                    while (noise.length < Math.min(3, Math.max(0, 6 - letters.length))) {
                        const n = pool[Math.floor(Math.random() * pool.length)];
                        if (!letters.includes(n)) noise.push(n);
                    }
                }
                current = {
                    word: word,
                    fullWord: chosen.w,
                    hint: chosen.hint || "--",
                    letters,
                    noise
                };
                renderRound();
            }

            function renderRound() {
                el.result.className = "result";
                el.result.style.display = "none";
                el.btnNext.disabled = true;

                el.levelNow.textContent = state.level;
                el.scoreNow.textContent = state.score;
                el.hintText.textContent = current.hint;
                el.wordLen.textContent = current.letters.length;
                el.progress.style.setProperty("--p", progressPercent() + "%");

                // فراغات slots
                el.slots.innerHTML = "";
                current.letters.forEach((_, i) => {
                    const s = document.createElement("div");
                    s.className = "slot";
                    s.dataset.index = i;
                    s.addEventListener("dragover", ev => ev.preventDefault());
                    s.addEventListener("drop", onDropToSlot);
                    el.slots.appendChild(s);
                });

                // بنك الحروف
                el.bank.innerHTML = "";
                const tiles = shuffle([...current.letters, ...current.noise]);
                tiles.forEach(ch => el.bank.appendChild(makeTile(ch)));
            }

            function makeTile(ch) {
                const t = document.createElement("div");
                t.className = "tile";
                t.draggable = true;
                t.textContent = ch;
                t.dataset.letter = ch;
                t.addEventListener("dragstart", ev => {
                    t.classList.add("dragging");
                    ev.dataTransfer.setData("text/plain", ch);
                    // نضع معرف العنصر لنستطيع إرجاعه
                    ev.dataTransfer.setData("text/id", Date.now() + "_" + Math.random());
                    // نخزن مرجع العنصر نفسه
                    window.__draggingTile = t;
                });
                t.addEventListener("dragend", () => t.classList.remove("dragging"));
                t.addEventListener("dblclick", () => { // نقر مزدوج يعيده للبنك/يفرغ
                    if (t.parentElement && t.parentElement.classList.contains("slot")) {
                        t.parentElement.classList.remove("filled");
                    }
                    el.bank.appendChild(t);
                });
                t.addEventListener("click", () => {
                    // بحث عن أول سلوت فارغ
                    const emptySlot = [...el.slots.children].find(s => !s.firstElementChild);
                    if (emptySlot) {
                        if (t.parentElement && t.parentElement.classList.contains("slot")) {
                            t.parentElement.classList.remove("filled");
                        }
                        emptySlot.appendChild(t);
                        emptySlot.classList.add("filled");
                        beep(900, 60, "triangle", .02);
                    }
                });
                return t;
            }

            function onDropToSlot(ev) {
                ev.preventDefault();
                const slot = ev.currentTarget;
                const tile = window.__draggingTile;
                if (!tile) return;

                // لو كان في السلوت حرف مسبقاً، نرجعه للبنك
                if (slot.firstElementChild) {
                    el.bank.appendChild(slot.firstElementChild);
                }
                slot.innerHTML = "";
                slot.appendChild(tile);
                slot.classList.add("filled");
                beep(900, 60, "triangle", .02);
            }

            function collectAnswer() {
                const letters = [...el.slots.children].map(s => s.firstElementChild ? s.firstElementChild.dataset.letter : "");
                return letters.join("");
            }

            function showResult(ok, msg) {
                el.result.className = "result " + (ok ? "ok" : "bad");
                el.result.textContent = msg;
                el.result.style.display = "block";
            }

            function progressPercent() {
                if (!state.done[state.level]) return 0;

                const bank = getFullBank()[state.level] || [];
                const total = bank.length || 1;
                const done = state.done[state.level].length;
                return Math.round(100 * done / total);
            }

            function check() {
                const ans = collectAnswer();
                if (ans.length !== current.letters.length) {
                    beep(200, 150, "sawtooth", .03);
                    return showResult(false, "كمّلي جميع الحروف أولاً 👀");
                }

                // للجمل والكلمات المعقدة، نتحقق من الكلمة الكاملة بدون المسافات
                if (ans === current.word) {
                    // صحيح
                    showResult(true, "🎉 أحسنتِ! إجابة صحيحة");
                    el.btnNext.disabled = false;
                    state.score += 5;
                    // وسّمي الكلمة منجزة
                    if (!state.done[state.level]) {
                        state.done[state.level] = [];
                    }
                    if (!state.done[state.level].includes(current.fullWord)) {
                        state.done[state.level].push(current.fullWord);
                    }
                    saveState();
                    confetti();

                    // استخدم صوت النجاح الجديد
                    playSoundSuccess();
                } else {
                    // خطأ
                    showResult(false, "❌ ليست صحيحة. جرّبي خلط الحروف أو استخدمي تلميحًا إضافيًا.");
                    state.score = Math.max(0, state.score - 1);
                    saveState();
                    shake(el.slots);
                    beep(160, 220, "sine", .03);
                }
                el.scoreNow.textContent = state.score;
                el.progress.style.setProperty("--p", progressPercent() + "%");
            }

            function resetRound() {
                // أعِد كل البلاطات للبنك وأفرغ الخانات
                [...el.slots.children].forEach(s => {
                    if (s.firstElementChild) el.bank.appendChild(s.firstElementChild);
                    s.classList.remove("filled");
                });
                el.result.style.display = "none";
            }

            function resetLevel() {
                if (confirm("هل تريد إعادة تعيين المستوى الحالي؟")) {
                    if (state.done[state.level]) {
                        state.done[state.level] = [];
                        saveState();
                        resetRound();
                        pickWord();
                    }
                }
            }

            function extraHint() {
                // يكشف حرفًا عشوائيًا صحيحًا لم يُوضع بعد
                const emptyIdx = [...el.slots.children]
                    .map((s, i) => s.firstElementChild ? null : i)
                    .filter(i => i !== null);
                if (emptyIdx.length === 0) return;
                const i = rand(emptyIdx);
                const target = current.letters[i];

                // ابحثي عن بلاطة بالحرف الهدف (قد تكون في البنك أو في خانة خاطئة)
                // 1) في البنك
                let tile = [...el.bank.children].find(t => t.dataset.letter === target);
                // 2) أو في خانة خاطئة
                if (!tile) {
                    const wrong = [...el.slots.children].find(s => s.firstElementChild && s.firstElementChild.dataset.letter === target && Number(s.dataset.index) !== i);
                    if (wrong) {
                        tile = wrong.firstElementChild;
                        wrong.classList.remove("filled");
                    }
                }
                if (tile) {
                    // لو في السلوت حرف، أرجعيه للبنك
                    const slot = el.slots.children[i];
                    if (slot.firstElementChild) el.bank.appendChild(slot.firstElementChild);
                    slot.innerHTML = "";
                    slot.appendChild(tile);
                    slot.classList.add("filled");
                    beep(1000, 80, "triangle", .03);
                    showResult(false, "🪄 تم الكشف عن حرف واحد.");
                }
            }

            function shuffleBank() {
                const tiles = [...el.bank.children];
                const mixed = shuffle(tiles);
                mixed.forEach(t => el.bank.appendChild(t));
                beep(700, 60, "sine", .02);
            }

            function nextRound() {
                pickWord();
            }

            // مؤثرات بسيطة
            function shake(node) {
                node.animate([{
                    transform: "translateX(0)"
                }, {
                    transform: "translateX(-6px)"
                }, {
                    transform: "translateX(6px)"
                }, {
                    transform: "translateX(0)"
                }], {
                    duration: 220,
                    iterations: 1
                });
            }

            function confetti() {
                const n = 25,
                    dur = 1200;
                for (let i = 0; i < n; i++) {
                    const p = document.createElement("div");
                    p.style.position = "fixed";
                    p.style.width = "10px";
                    p.style.height = "10px";
                    p.style.background = `hsl(${Math.random()*360},90%,60%)`;
                    p.style.insetInlineStart = (Math.random() * 80 + 10) + "vw";
                    p.style.insetBlockStart = "0vh";
                    p.style.borderRadius = "2px";
                    p.style.transform = `rotate(${Math.random()*360}deg)`;
                    p.style.zIndex = 9999;
                    document.body.appendChild(p);
                    p.animate([{
                            transform: `translateY(0) rotate(0deg)`
                        }, {
                            transform: `translateY(80vh) rotate(${Math.random()*720-360}deg)`
                        }], {
                            duration: dur + Math.random() * 600,
                            easing: "cubic-bezier(.2,.7,.2,1)"
                        })
                        .onfinish = () => p.remove();
                }
            }

            // إعداد مختار المستويات
            function setupLevelSelector() {
                const levelCards = el.levelSelector.querySelectorAll('.level-card');
                levelCards.forEach(card => {
                    const level = parseInt(card.dataset.level);
                    card.addEventListener('click', () => {
                        levelCards.forEach(c => c.classList.remove('active'));
                        card.classList.add('active');

                        state.level = level;
                        if (!state.done[level]) {
                            state.done[level] = [];
                        }
                        saveState();
                        el.levelsDlg.close();
                        resetRound();
                        pickWord();
                    });

                    // وضع علامة active على المستوى الحالي
                    if (level === state.level) {
                        card.classList.add('active');
                    }
                });
            }

            // أحداث الأزرار
            el.btnCheck.addEventListener("click", check);
            el.btnReset.addEventListener("click", resetRound);
            el.btnResetLevel.addEventListener("click", resetLevel);
            el.btnShuffle.addEventListener("click", shuffleBank);
            el.btnHint.addEventListener("click", extraHint);
            el.btnNext.addEventListener("click", nextRound);
            el.btnTeacher.addEventListener("click", () => el.teacherDlg.showModal());
            el.btnLevels.addEventListener("click", () => {
                setupLevelSelector();
                el.levelsDlg.showModal();
            });

            // أزرار إعادة التعيين
            el.btnClearLevelProgress.addEventListener("click", () => {
                if (confirm(`هل تريد إعادة تعيين التقدم للمستوى ${state.level}؟`)) {
                    if (state.done[state.level]) {
                        state.done[state.level] = [];
                        saveState();
                        alert(`تم إعادة تعيين المستوى ${state.level}`);
                        el.levelsDlg.close();
                        pickWord();
                    }
                }
            });

            el.btnClearAllProgress.addEventListener("click", () => {
                if (confirm("هل تريد إعادة تعيين كل التقدم في جميع المستويات؟")) {
                    state.done = {};
                    state.score = 0;
                    saveState();
                    alert("تم إعادة تعيين كل التقدم");
                    el.levelsDlg.close();
                    pickWord();
                }
            });

            // وضع المعلّم
            el.btnAddWord.addEventListener("click", () => {
                const w = (el.tWord.value || "").trim();
                const hint = (el.tHint.value || "").trim() || "--";
                const lvl = Number(el.tLevel.value || "1");
                const noise = (el.tNoise.value || "").trim();
                if (!w) {
                    alert("اكتبي الكلمة أولًا.");
                    return;
                }
                const data = loadTeacherWords();
                if (!data[lvl]) data[lvl] = [];
                data[lvl].push({
                    w,
                    hint,
                    noise
                });
                saveTeacherWords(data);
                el.tWord.value = "";
                el.tHint.value = "";
                el.tNoise.value = "";
                alert("تمت الإضافة ✅ ستظهر في المستوى عند التشغيل التالي.");
            });

            el.btnClearAll.addEventListener("click", () => {
                if (confirm("حذف كل كلمات المعلّم؟")) {
                    saveTeacherWords({});
                    alert("تم الحذف.");
                }
            });

            // تحقق من المستوى الحالي - إذا كان المستوى 2 أو 5، ننتقل إلى المستوى 1
            if (state.level === 2 || state.level === 5) {
                state.level = 1;
                saveState();
            }

            // بدء اللعبة
            setupLevelSelector();
            pickWord();

        })();
    </script>
</body>

</html>